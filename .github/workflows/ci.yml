name: Demo

on:
  pull_request:
    branches: ["sandbox", "development", "staging", "main"]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      app01: ${{ steps.filter.outputs.app01 }}
      app02: ${{ steps.filter.outputs.app02 }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect Lambda changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            app01:
              - 'lambdas/app01/**'
            app02:
              - 'lambdas/app02/**'

  lambda-pipeline:
    needs: detect-changes
    runs-on: ubuntu-latest

    strategy:
      max-parallel: 1   # ðŸ”¥ forces app01 â†’ app02 execution
      matrix:
        lambda: [app01, app02]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Skip if no changes
        if: needs.detect-changes.outputs[matrix.lambda] != 'true'
        run: |
          echo "No changes in ${{ matrix.lambda }}, skipping pipeline"
          exit 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      # ---------- LINT ----------
      - name: Lint
        run: |
          go install golang.org/x/lint/golint@latest
          golint ./...
        working-directory: ./lambdas/${{ matrix.lambda }}

      # ---------- TEST ----------
      - name: Test
        run: go test ./... -v
        working-directory: ./lambdas/${{ matrix.lambda }}

      # ---------- BUILD & PACKAGE ----------
      - name: Build & Package
        if: contains(fromJSON('["sandbox","development","staging","main"]'), github.base_ref)
        uses: ./.github/workflows/build-and-package.yml
        with:
          environment: ${{ github.base_ref }}
          lambda_name: ${{ matrix.lambda }}
          changed: true
        secrets: inherit
